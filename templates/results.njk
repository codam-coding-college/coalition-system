{% extends "base.njk" %}
{% set nomargin = false %}
{% set page_title = "Season results" %}

{% block content %}

<!-- Season chooser (basically just a bootstrap.js page navigation) -->
<nav aria-label="Season navigation" class="d-flex justify-content-center" id="pagenav">
	<ul class="pagination">
		{% for endedSeason in endedSeasons %}
		<li class="page-item">
			<a class="page-link{{ ' active' if endedSeason.id === season.id }}" href="/results/{{ endedSeason.id }}">{{ endedSeason | seasonName }}</a>
		</li>
		{% endfor %}
	</ul>
</nav>

<!-- main page content -->
<div class="container-lg mw-900">
	<!-- winner container -->
	<!-- this data comes from Intra directly, not from Codam's coalition system -->
	{% if season.coalition_id %}
		<div class="card w-100 mb-4" id="winner" style="overflow: hidden;">
			<div class="card-header pe-2 d-flex align-items-center" style="border-bottom: none; background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%), radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%);">
				<h4 class="d-inline-block pe-3 lh-lg flex-grow-1 text-black">Season Winner</h4>
				<div class="d-inline-block">

				</div>
			</div>
			<div class="">
				<ol class="list-group noborder">
					<li class="list-group-item big-coalition-row" style="background-color: {{ season.coalition.color | rgba(0.5) }}; background-image: url({{ season.coalition.cover_url }})">
						<a href="/coalitions/{{ season.coalition.id }}">
							<div class="big-coalition-logo">
								<img src="{{ season.coalition.image_url }}" style="filter: invert(1);" />
							</div>
							<div class="big-coalition-content">
								<h2 class="coalition-name"><b style="text-transform: uppercase;">{{ season.coalition.name | striptags(true) | escape }}</b></h2>
							</div>
						</a>
					</li>
				</ol>
			</div>
		</div>
	{% endif %}

	<!-- leaderboard result -->
	{% if seasonResults | length == 0 %}
		<p class="text-muted p-4"><i>No individual coalition results available for this season.</i></p>
	{% endif %}

	<!-- leaderboards per coalition -->
	<!-- this data comes from Codam's coalition system, not from Intra directly -->
	{% for seasonResult in seasonResults %}
		<div class="card w-100 mb-4" id="leaderboards" style="overflow: hidden;">
			<div class="card-header pe-2 d-flex align-items-center" style="background-color: {{ seasonResult.coalition.intra_coalition.color | rgba(0.5) }};">
				<h4 class="d-inline-block pe-3 lh-lg flex-grow-1 text-white">{{ seasonResult.coalition.intra_coalition.name | striptags(true) | escape }} Leaderboards</h4>
				<div class="d-inline-block">

				</div>
			</div>
			<div class="">
				<ol class="list-group list-group-numbered custom-number noborder">
					<li data-number="{{ loop.index }}" class="list-group-item big-coalition-row" style="background-color: {{ seasonResult.coalition.intra_coalition.color | rgba(0.5) }}; background-image: url({{ seasonResult.coalition.intra_coalition.cover_url }})">
						<a href="/coalitions/{{ seasonResult.coalition.intra_coalition.id }}">
							<div class="big-coalition-logo">
								<img src="{{ seasonResult.coalition.intra_coalition.image_url }}" style="filter: invert(1);" />
							</div>
							<div class="big-coalition-content">
								<h4 class="coalition-name"><b>{{ seasonResult.coalition.intra_coalition.name | striptags(true) | escape }}</b></h4>
								<p class="coalition-description">{{ seasonResult.score | thousands }} points</p>
							</div>
						</a>
					</li>
				</ol>
				<table class="table table-striped mb-0">
					<tbody>
						{% for userScore in seasonResult.scores %}
							<tr style="vertical-align: middle;">
								<td class="fs-5 p-2" style="width: 25px;">{{ userScore.coalition_rank }}.</td>
								<td class="p-0">
									<div class="d-inline-flex flex-row justify-content-start align-items-center text-light">
										<a href="/profile/{{ userScore.user.intra_user.login }}" class="p-2 text-light" style="text-decoration: none;">
											<img loading="lazy" src="{{ userScore.user.intra_user.image }}" class="user-picture rounded-circle d-inline-block me-2" height="32" />
											<span>{{ userScore.user.intra_user.usual_full_name | striptags(true) | escape }}</span>
										</a>
									</div>
								</td>
								<td class="text-end ps-2 pe-2 mt-0 mb-2">{{ userScore.score | thousands }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				{# if no rankings, display a message #}
				{% if seasonResult.scores | length == 0 %}
					<p class="text-muted p-4"><i>No individual leaderboards available for this coalition.</i></p>
				{% endif %}
			</div>
		</div>
	{% endfor %}

	<!-- rankings -->
	<!-- this data comes from Codam's coalition system, not from Intra directly -->
	{% for ranking in rankings %}
		<div class="card w-100 mb-4" id="ranking-{{ ranking.type }}">
			<div class="card-header pe-2 d-flex align-items-center" style="background-color: #6c757d;">
				<h4 class="d-inline-block pe-3 lh-lg flex-grow-1 text-white">{{ ranking.name | striptags(true) | escape }}</h4>
				<div class="d-inline-block">

				</div>
			</div>
			<div class="card-body p-0">
				<p class="p-4 pb-2">{{ ranking.description | striptags(true) | escape | nl2br }}</p>
				<table class="table coalition-colored mb-0">
					<tbody>
						{# TODO: build a nice big highlight of the winner(s) #}
						{% for result in ranking.results %}
							<tr style="background: {{ result.coalition.intra_coalition.color | rgba(0.25) if result.coalition else 'transparent' }}; vertical-align: middle;">
								<td class="fs-5 p-2" style="width: 25px;">{{ result.rank }}.</td>
								<td class="p-0">
									<div class="d-inline-flex flex-row justify-content-start align-items-center text-light">
										<a href="/profile/{{ result.user.intra_user.login | striptags(true) | escape }}" class="p-2 text-light" style="text-decoration: none;">
											<img loading="lazy" src="{{ result.user.intra_user.image }}" class="user-picture rounded-circle d-inline-block me-2" height="32" />
											<span>{{ result.user.intra_user.usual_full_name | striptags(true) | escape }}</span>
										</a>
									</div>
								</td>
								<td class="text-end ps-2 pe-2 mt-0 mb-2">{{ result.score | thousands }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				{# if no rankings, display a message #}
				{% if ranking.results | length == 0 %}
					<p class="text-muted p-4"><i>No rankings available for this season.</i></p>
				{% endif %}
			</div>
		</div>
	{% endfor %}
</div>

{% endblock %}
