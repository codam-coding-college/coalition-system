generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("PRISMA_DB_URL")
}

// ********************************************* //
// CUSTOM CODAM SECTION                          //
// ********************************************* //

model CodamUser {
	id               Int      @id // Same as intra user id

	// Relations
	coalition_scores CodamCoalitionScore[]
	user_results     CodamCoalitionUserResult[]
	user_rankings    CodamCoalitionRankingResult[]
	title_users      CodamCoalitionTitleUser[]

	// Link to Intra
	intra_user       IntraUser   @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model CodamCoalition {
	id               Int      @id // Same as intra coalition id
	tagline          String?
	description      String?

	// Relations
	coalition_scores CodamCoalitionScore[]
	coalition_test_answers CodamCoalitionTestAnswer[]
	season_results   CodamCoalitionSeasonResult[]
	user_results     CodamCoalitionUserResult[]
	ranking_results  CodamCoalitionRankingResult[]
	titles           CodamCoalitionTitle[]

	// Link to Intra
	intra_coalition  IntraCoalition   @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

// A cross-coalition ranking for each fixed-point type.
// During the last week of each season, every hour a specific amount of points will be awarded to the #1 spot(s) in each ranking.
model CodamCoalitionRanking {
	type             String   @id
	name             String   // The name of the cross-coalition ranking that this type of score contributes to (e.g. Guiding Stars)
	description      String   @default("")
	top_title        String   // The title of the top of the ranking (e.g. #1 Guiding Star)
	bonus_points     Int?     // Total bonus points to distribute for this ranking (will be divided into 168 hours = 1 week and distributed each hour)
	disabled         Boolean  @default(false) // If disabled, this ranking will not be calculated at the end of a tournament
	last_bonus_run   DateTime? // The last time bonus points were awarded for this ranking

	fixed_types      CodamCoalitionFixedType[] // The #1 is calculated by the sum of all fixed types of the same ranking type
	results          CodamCoalitionRankingResult[]
}

// Fixed type of score for the coalition system
model CodamCoalitionFixedType {
	type             String   @id // should not contain spaces. e.g. "project", "eval", "point_donated", "logtime", "idle_logout", "exam", "basic_event", "intermediate_event", "advanced_event", "ranking_bonus", etc.
	description      String
	point_amount     Int
	ranking_type     String?  // The ranking type that this fixed type of score contributes to (leave empty to disable ranking, does not need to be unique)

	created_at       DateTime @default(now())
	updated_at       DateTime @default(now()) @updatedAt

	// Relations
	scores           CodamCoalitionScore[]
	ranking          CodamCoalitionRanking? @relation(fields: [ranking_type], references: [type], onDelete: SetNull, onUpdate: Cascade)
}

model CodamCoalitionScore {
	id               Int      @id @default(autoincrement())
	coalition_id     Int
	user_id          Int
	amount           Int
	reason           String   // Does not necessarily have to be the same as on Intra
	fixed_type_id    String?  // If the type is of a fixed type with a predefined amount of points, this will be set. If it is custom, this will be null.
	type_intra_id    Int?     // Id of the object that caused the score to be created, if created by something specific (e.g. a location, project_user, scale_team, etc.)

	created_at       DateTime @default(now())
	updated_at       DateTime @default(now()) @updatedAt

	// Relations
	coalition        CodamCoalition   @relation(fields: [coalition_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	user             CodamUser        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	fixed_type       CodamCoalitionFixedType? @relation(fields: [fixed_type_id], references: [type], onDelete: SetNull, onUpdate: Cascade)

	// Link to Intra
	intra_score_id   Int?     @unique
	// intra_score      IntraScore?   @relation(fields: [intra_score_id], references: [id])
}

model CodamCoalitionSeasonResult {
	id               Int      @id @default(autoincrement())
	coalition_id     Int
	score            Int      // NOT the same as the sum of all scores, but the score after applying the normal distribution
	bloc_deadline_id Int

	created_at       DateTime @default(now())
	updated_at       DateTime @default(now()) @updatedAt

	// Relations
	coalition        CodamCoalition    @relation(fields: [coalition_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	scores           CodamCoalitionUserResult[]

	// Link to Intra
	bloc_deadline    IntraBlocDeadline @relation(fields: [bloc_deadline_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

	// Make coalition_id + bloc_deadline_id unique together
	@@unique([coalition_id, bloc_deadline_id])
}

model CodamCoalitionUserResult {
	id               Int      @id @default(autoincrement())
	user_id          Int
	coalition_id     Int
	score            Int
	coalition_rank   Int      // No. in the coalition (1 = first, 2 = second, etc.)
	season_result_id Int

	created_at       DateTime @default(now())
	updated_at       DateTime @default(now()) @updatedAt

	// Relations
	user             CodamUser        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	coalition        CodamCoalition   @relation(fields: [coalition_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	season_result    CodamCoalitionSeasonResult @relation(fields: [season_result_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

	// Make season_result_id + coalition_id + user_id unique together
	@@unique([season_result_id, coalition_id, user_id])
}

model CodamCoalitionRankingResult {
	id               Int      @id @default(autoincrement())
	ranking_type     String
	bloc_deadline_id Int   // The bloc deadline (season) this ranking was for
	user_id          Int
	coalition_id     Int?
	score            Int
	rank             Int   // No. in the ranking (1 = first, 2 = second, etc.)

	// Relations
	user             CodamUser        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	coalition        CodamCoalition?  @relation(fields: [coalition_id], references: [id], onDelete: SetNull, onUpdate: Cascade)
	ranking          CodamCoalitionRanking @relation(fields: [ranking_type], references: [type], onDelete: Cascade, onUpdate: Cascade)

	// Link to Intra
	bloc_deadline    IntraBlocDeadline @relation(fields: [bloc_deadline_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

	// Make bloc_deadline_id + ranking_type + user_id unique together
	@@unique([bloc_deadline_id, ranking_type, user_id])
}

// Sorting hat quiz settings
model CodamCoalitionTestSettings {
	id               Int      @id // Only one of these should exist
	start_at         DateTime // Schedule the start of quiz taking (before this the quiz is not available)
	deadline_at      DateTime // Deadline for doing the quiz and selecting a coalition
}

// For the "sorting hat" quiz
model CodamCoalitionTestQuestion {
	id               Int      @id @default(autoincrement())
	question         String

	// Relations
	answers          CodamCoalitionTestAnswer[] // Can be more than 3 theoretically, in case there are more coalitions
}

// An answer to a question in the "sorting hat" quiz
model CodamCoalitionTestAnswer {
	id               Int      @id @default(autoincrement())
	question_id      Int
	answer           String
	coalition_id     Int
	weight           Int      @default(10) // Amount of points to add to the coalition score in the student's quiz result (can be negative too!)

	// Relations
	coalition        CodamCoalition @relation(fields: [coalition_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	question         CodamCoalitionTestQuestion @relation(fields: [question_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

// A title for a rank within a coalition
// Inspired from the old https://github.com/codam-coding-college/coalition-ranks
model CodamCoalitionTitle {
	id               Int      @id @default(autoincrement())
	title            String   @unique
	intra_title_id   Int?     @unique  // The id of the Title in Intra
	coalition_id     Int
	ranking          Int      // Rank number (1 = first, 2 = second, etc.)

	// Relations
	coalition        CodamCoalition @relation(fields: [coalition_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	title_users      CodamCoalitionTitleUser[]  // Connections to users who have this title

	// Make coalition_id + ranking unique together
	@@unique([coalition_id, ranking])
}

// A connection between a Coalition Title and a Codam User
model CodamCoalitionTitleUser{
	id               Int      @id @default(autoincrement())
	user_id          Int
	title_id         Int
	intra_title_user_id  Int?     @unique  // The id of the TitlesUsers object in Intra

	created_at       DateTime @default(now())
	updated_at       DateTime @default(now()) @updatedAt

	// Relations
	user             CodamUser        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	title            CodamCoalitionTitle @relation(fields: [title_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

	// Make user_id + title_id unique together
	@@unique([user_id, title_id])
}

// ********************************************* //
// INTRA SECTION                                 //
// All ids here are defined by Intra             //
// ********************************************* //

// Intra User
model IntraUser {
	id               Int      @id
	email            String
	login            String
	first_name       String
	last_name        String
	usual_first_name String?
	usual_full_name  String
	display_name     String
	kind             String
	image            String?
	pool_month       String?
	pool_year        String?
	anonymize_date   DateTime?

	created_at       DateTime
	updated_at       DateTime

	// Relations
	coalition_users  IntraCoalitionUser[]
	cursus_users     IntraCursusUser[]

	// Codam
	codam_user      CodamUser?
}

// Intra Bloc
// Defines one coalition "tournament" in Intra
model IntraBloc {
	id               Int      @id
	cursus_id        Int
	squad_size       Int?

	created_at       DateTime
	updated_at       DateTime

	// Relations
	coalitions       IntraCoalition[]
	deadlines        IntraBlocDeadline[]
}

// Intra Bloc Deadline
model IntraBlocDeadline {
	id               Int      @id
	bloc_id          Int
	coalition_id     Int?     // Defines the winner?
	begin_at         DateTime
	end_at           DateTime

	created_at       DateTime
	updated_at       DateTime

	// Relations
	bloc             IntraBloc         @relation(fields: [bloc_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	coalition        IntraCoalition?   @relation(fields: [coalition_id], references: [id], onDelete: SetNull, onUpdate: Cascade)

	// Codam
	codam_season_result CodamCoalitionSeasonResult[]
	codam_ranking_results CodamCoalitionRankingResult[]
}

// Intra Coalition
model IntraCoalition {
	id               Int      @id
	name             String
	slug             String
	image_url        String?
	cover_url        String?
	color            String?
	score            Int
	user_id          Int?    // Coalition leader user id

	// Relations
	blocs            IntraBloc[]
	coalition_users  IntraCoalitionUser[]
	deadlines        IntraBlocDeadline[]

	// Codam
	codam_coalition  CodamCoalition?
}

// Intra Coalition User
// Links a user to a coalition
model IntraCoalitionUser {
	id               Int      @id
	coalition_id     Int
	user_id          Int
	score            Int
	rank             Int

	created_at       DateTime
	updated_at       DateTime

	// Relations
	user             IntraUser        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
	coalition        IntraCoalition   @relation(fields: [coalition_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model IntraCursusUser {
	id               Int      @id
	cursus_id        Int      @map("cursus_id")
	user_id          Int      @map("user_id")
	begin_at         DateTime
	end_at           DateTime?
	level            Float
	grade            String?

	created_at       DateTime
	updated_at       DateTime

	// Relations
	user             IntraUser     @relation(fields: [user_id], references: [id])
}

// Intra Project
// Defines a project in Intra, used for the coalition system's point system
model IntraProject {
	id               Int      @id
	name             String
	slug             String
	difficulty       Int?
	description      String?
	exam             Boolean

	created_at       DateTime
	updated_at       DateTime
}

model IntraWebhook {
	delivery_id      String   @id
	model            String
	event            String
	body             String
	status           String

	received_at      DateTime @default(now())
	handled_at       DateTime?
}

model IntraWebhookSecret {
	model            String
	event            String
	secret           String

	created_at       DateTime @default(now())
	updated_at       DateTime @default(now()) @updatedAt

	@@id([model, event]) // Composite primary key
}

// Session management
// https://www.npmjs.com/package/@quixo3/prisma-session-store
model Session {
	id               String   @id
	sid              String   @unique
	data             String
	expiresAt        DateTime
}
